#!/bin/bash
# SPDX-License-Identifier: MIT-0

set -euxo pipefail

maybe_sudo=
if [[ "${EUID}" -ne 0 ]]; then
  maybe_sudo=sudo
fi

if [[ "$OSTYPE" == "linux"* ]]; then
    # Ubuntu-specific installations
    # See https://github.com/RobotLocomotion/drake/blob/master/tools/wheel/content/INSTALLATION
    # for a complete list of the required libraries to be installed.
    ${maybe_sudo} apt-get update
    ${maybe_sudo} apt-get install --no-install-recommends $(cat <<EOF
      libegl1
      libglib2.0-0
      libsm6
      libx11-6
EOF
    )
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS-specific logic
    # enforce use of Python 3.12 if available, otherwise fall back to 3.11
    if brew list python@3.11 &>/dev/null || brew list python@3.12 &>/dev/null; then
        if brew list python@3.12 &>/dev/null; then
            PYTHON_VERSION=${1:-'3.12'}
        else
            PYTHON_VERSION=${1:-'3.11'}
        fi
    else
        echo "ERROR: Compatible Python interpreter not found!"
        echo "Please install Python 3.12 via Homebrew: brew install python@3.12"
        exit 1
    fi
else
    # Default for non-macOS platforms
    PYTHON_VERSION=${1:-'3'}
fi

# If a version of Python other than the default (3) is provided,
# enforce that poetry use that version.
echo "Creating poetry environment with python${PYTHON_VERSION}"
poetry env use $PYTHON_VERSION

# Install poetry dependencies
poetry install
